---
title: 校园网络配置最佳实践
date: 2024-05-16 10:00:00 +0800
categories: [技术, 网络]
tags: [加速, 校园网]
---

校园网络的配置需要有以下内容：

1. 网络必须足够快，成本必须足够低

   我校的校园网Internet接入有以下接口

   - 学校自购的网络出口

     这是教学/科研/办公OA等场景的网络，在Portal认证时，选择“校园网”即这种网络接入。网络质量最好，有线网络在300Mbps左右，完全可以满足各类需求，但对于学生来说，这种网络如果使用无线接入或非教学区的有线接入，将只有4GB的限额，互联网，尤其是移动互联网发展到现在，这种限额是不可理喻的。

     这种自购的网络出口有CERNET,电信，联通和移动的出口，可实现上下速率对等和负载均衡，网络质量优良。

   - 运营商搭建的网络出口

     这种形式的网络出口一般单用户接入的速率最高不超过50Mbps，高峰期往往只有20Mbps，不过对于视频流来说，也是可以接受的速率。但是这种形式的接入使得用户的公网IP变成了运营商的IP，如果访问一些限定IP的数据库，这种IP就没有办法访问。这是一些用户报告“明明连了校园网，但是xx数据库还是打不开”的关键原因。

   因此，网络出口需要使用学校自购的出口，并使用代理服务器等方式让Portal认证系统免除流量费用

2. 必须具备完整的海外网络接入

   OpenAI与Gemini有严格的IP地址限制，仅仅能访问Google是不够的，必须要有美国或日本的IP方可访问，可以使用Azure的日本节点，其速度极快,但流量费用较贵；也可以使用DigitalOcean的美国节点，速度尚可，优势在于流量费用低廉。因此最佳实践便是使用负载均衡策略平衡二者。

   在访问方面需要对出海流量进行伪装，常见的伪装协议有trojan vless vmess hysteria2等，其中最为便利的是hysteria2，其速度快，延迟低，另外不需要域名，只是在配置SSL证书上需要一番功夫，大概需要几小时学习证书的配置方式以及安装方法，如果拥有域名，可以参考Hysteria2的官方介绍进行安装配置，对acme熟悉的话可以很快搞定。如果不考虑其他因素，只是希望接入海外网络，可以使用vmess，但是需要域名。vmess也有不使用证书的安装方式，但需提防IP被封禁。另外还有不少新协议，可以参考如下文档：[代理协议介绍](https://hugengrui.github.io/posts/%E4%BB%A3%E7%90%86%E5%8D%8F%E8%AE%AE%E4%BB%8B%E7%BB%8D/)

3. 连接网络需要“无感”

   所谓的“无感”，就是网络一旦配置完毕，再次连接时不需要考虑是不是启动了代理，连接网络后自动为国内ip和海外ip执行分流，整个过程可以参考学习如下记录文档:[网络配置过程记录](https://hugengrui.github.io/posts/%E9%85%8D%E7%BD%AE%E6%97%81%E8%B7%AF%E7%94%B1%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/)

   最佳实践便是：在路由器下接入一个Linux主机，负责接收所有的流量，其规则如下：

   | 流量类别 |       动作        |
   | :------: | :---------------: |
   |   国内   |   直连/加速直连   |
   |   海外   | 代理/负载均衡代理 |
   |   广告   |       丢弃        |

   代理服务器具备高速的网络访问和足够的性能（双核酷睿以上即可，需要有AES-IN硬件加速，因其需要处理网络数据包的加解密），Linux主机则不需要这样的性能，只需要满足clash的基本转发性能即可，例如双核1007U 2GB内存主机即可应付类似测速这种场景，J3710虽为4核，其单核性能较弱，其优点在于低功耗。

   移动设备（如Android设备），指定好WiFi的代理服务器，将网关指定到Linux主机的IP即可

4. 去除广告

   参考如下的配置：[去除广告repo](https://github.com/Hugengrui/anti-AD/tree/master)

### 无线设备配置

- 本校的校园网络已更新，目前配置是全校无线接入WiFi6，有线千兆，部分地区可见WiFi7的无线接入点。

  校园网会对单个用户限速，大致为300Mbps，高峰期速率会降低。可以使用代理服务器的方法突破限速。

- 网络连接的速度遵循木桶效应，在网络传输中，最差的一段网络传输速度往往是整条线路的传输上限。有线连接已经是全千兆，而无线连接没有达到千兆，其原因在于WiFi的传输速度。之前的路由器是小米r3g，刷入了padavan系统，无线理论传输速度在867Mbps，实际一般在400Mbps以下。根据经验，无线的实际传输速度近似为理论传输速度的一半，所以为了让无线传输达到千兆，理论传输速度应在2Gbps以上。

  目前来说，符合此要求的协议是WiFi6，且需要2x2 mimo，传输带宽为160MHz，其理论传输速率是2.4Gbps。早在2020年就有支持此要求的无线网卡上市，即intel AX200，而符合此要求的手机直到2023年才大规模普及。路由器方面，搭载高通的IPQ5018，IPQ6000以及联发科的MT7981b处理器也已大规模上市，路由器厂商一般都会宣传自己的路由器达到3000Mbps（2.4GHz：600Mbps，5GHz：2401Mbps）。一代神U——联发科的MT7621仍然有WiFi6机器使用，但是无线千兆是达不到的，一般此类路由器会说自己是AX1800（5GHz频段传输带宽只有80MHz，理论速率为1201Mbps），这是因为MT7621没有无线转发的硬件加速，大量的数据包会触发大量的软中断，CPU性能成为速率的瓶颈。

- 但是需要指出的是，目前的无线硬件加速只支持WAN$\leftrightarrow$LAN方向的硬件加速，不支持LAN$\leftrightarrow$LAN的硬件加速，目前原因未知。不过这种情况导致使用软路由作为网关的无线设备无法硬件加速，但在实际使用中并没有发现体验上的差异。原因考虑如下：

  - 路由器的CPU性能足够，即使是没有无线硬件加速也能保证无线设备达到较高的速率。
  - 平时使用场景（看视频、浏览网页等）极少产生500Mbps以上的传输需求。



